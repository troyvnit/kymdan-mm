@model KymdanMM.Models.MaterialProposalViewModel
@{
    ViewBag.Title = "AddOrUpdateMaterialProposal";
}

<div class="row">&nbsp;</div>
<div class="row">
    <div class="panel panel-default">
        <div class="panel-heading">Thêm đề xuất</div>
        <div class="panel-body">
            @using (Html.BeginForm("AddOrUpdateMaterialProposal", "Home", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary()
                @Html.HiddenFor(m => m.Id)
                <div class="col-sm-6">
                    <div class="form-group">
                        @Html.LabelFor(m => m.ProposerUserName, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextBoxFor(m => m.ProposerUserName, new { disabled = "disabled" })
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.ImplementerUserName, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextBoxFor(m => m.ImplementerUserName)
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.Department, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextBoxFor(m => m.Department)
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.Description, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextAreaFor(m => m.Description, new { @class = "form-control" })
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        @Html.LabelFor(m => m.ManagementCode, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextBoxFor(m => m.ManagementCode, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.ProposalCode, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextBoxFor(m => m.ProposalCode, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.Note, new { @class = "col-md-4 control-label" })
                        <div class="col-sm-8 col-md-6">
                            @Html.TextAreaFor(m => m.Note, new { @class = "form-control" })
                        </div>
                    </div>
                </div>
                <div class="col-sm-12">
                    <div class="form-group">
                        @Html.Label("Danh sách vật tư", new { @class = "col-md-2 control-label" })
                        <div class="col-sm-10">
                            <div id="MaterialGrid"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-offset-10 col-md-2">
                            <input type="submit" class="btn btn-default" value="Lưu" />
                        </div>
                    </div>
                </div>
            }
            <div class="clearfix"></div>
            <div class="row">&nbsp;</div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">
        $(document).ready(function () {
            var materialProposalDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/Home/GetMaterialProposal",
                        type: "post"
                    },
                    update: {
                        url: "/Home/AddOrUpdateMaterialProposal",
                        type: "post"
                    },
                    destroy: {
                        url: "/Home/DeleteMaterialProposal",
                        type: "post",
                    },
                    create: {
                        url: "/Home/AddOrUpdateMaterialProposal",
                        type: "post"
                    },
                    parameterMap: function (options, operation) {
                        if (operation !== "read" && options.models) {
                            return {
                                models: kendo.stringify(options.models)
                            };
                        } else {
                            return {
                                keyWord: $("#keyWord").val(),
                                skip: options.skip,
                                take: options.take
                            };
                        }
                    }
                },
                batch: true,
                pageSize: 10,
                serverPaging: true,
                schema: {
                    model: {
                        id: "Id",
                        fields: {
                            Id: { editable: false, nullable: false, defaultValue: "" },
                            Description: { type: "string" },
                            ManagementCode: { type: "string" },
                            ProposalCode: { type: "string" },
                            ProposerUserName: { type: "string" },
                            ImplementerUserName: { type: "string" },
                            Department: { type: "string" },
                            ProgressStatus: { type: "string" },
                            Approved: { type: "boolean" },
                            Finished: { type: "boolean" },
                            Note: { type: "string" }
                        }
                    },
                    total: "total",
                    data: "data"
                }
            });

            $("#MaterialGrid").kendoGrid({
                dataSource: materialProposalDataSource,
                navigatable: true,
                pageable: true,
                height: 400,
                toolbar: [{ name: "create", text: "Thêm" }, { name: "save", text: "Lưu" }, { name: "cancel", text: "Hủy" }],
                columns: [
                    { field: "ImplementerUserName", title: "Người thực hiện" },
                    { field: "Description", title: "Mô tả" },
                    { field: "ProposerUserName", title: "Người đề xuất" },
                    {
                        field: "Department",
                        title: "Đơn vị đề nghị",
                        template: $("#departmentTemplate").html()
                    },
                    {
                        field: "ProgressStatus",
                        title: "Trạng thái tiến độ",
                        template: $("#departmentTemplate").html()
                    },
                    { field: "Approved", title: "Duyệt" },
                    { field: "Finished", title: "Hoàn thành" },
                    { field: "Note", title: "Ghi chú" },
                    { command: [{ name: "destroy", title: "&nbsp;", width: 70, text: "Xóa" }] }
                ],
                editable: true
            });

            $("#Department").kendoDropDownList({
                dataTextField: "DepartmentName",
                dataValueField: "Id",
                autoBind: true,
                optionLabel: "Chọn đơn vị",
                dataSource: {
                    severFiltering: true,
                    transport: {
                        read: {
                            url: "/Home/GetDepartment",
                            type: "post"
                        }
                    }
                }
            });
            
            $("#ProposerUserName").kendoDropDownList({
                dataTextField: "DisplayName",
                dataValueField: "UserName",
                autoBind: true,
                optionLabel: "Chọn người đề xuất",
                dataSource: {
                    severFiltering: true,
                    transport: {
                        read: {
                            url: "/Home/GetUser",
                            type: "post"
                        }
                    }
                }
            });

            $("#ImplementerUserName").kendoDropDownList({
                dataTextField: "DisplayName",
                dataValueField: "UserName",
                autoBind: true,
                optionLabel: "Chọn người thực hiện",
                dataSource: {
                    severFiltering: true,
                    transport: {
                        read: {
                            url: "/Home/GetUser",
                            type: "post"
                        }
                    }
                }
            });
        });
    </script>

}